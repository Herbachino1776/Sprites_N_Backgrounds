<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pill Peddler RPG v1.8</title>
  <style>
    /* Disable tap highlight & selection */
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }
    body { margin:0; overflow:hidden; background:#000; }
    canvas { display:block; margin:0 auto; background:#333; image-rendering:pixelated; }
    #ui { position:absolute; top:8px; left:8px; color:#fff; font-family:sans-serif; z-index:10; }
    #ui div { margin-bottom:.25em; }

    button, #overlay {
      position:absolute; z-index:100; font-family:sans-serif; text-align:center;
      pointer-events:auto;
    }
    button {
      padding:8px 16px; border:none; border-radius:4px;
      background:rgba(255,255,255,0.3); color:#000;
    }
    button:active { background:rgba(255,255,255,0.6); }

    #talk { bottom:16px; left:16px; }
    #action { bottom:16px; left:112px; }

    /* Retry button bottom-center */
    #retry {
      bottom:16px; left:50%; transform:translateX(-50%);
      width:240px; height:64px; font-size:24px;
      display:none;
    }
    #arrowBtn {
      top:50%; right:16px; transform:translateY(-50%);
      display:none;
    }
    #overlay {
      top:50%; left:50%; transform:translate(-50%,-50%);
      font-size:48px; color:red; display:none;
      animation: blink 1s infinite; white-space:nowrap;
    }
    @keyframes blink {
      0%,50%,100%{opacity:1}
      25%,75%{opacity:0}
    }
  </style>
</head>
<body>

<canvas id="game" width="640" height="480"></canvas>

<div id="ui">
  <div id="quest">Quest: None</div>
  <div id="inventory">Pills: 0  Money: $0</div>
  <div id="message"></div>
</div>

<button id="talk">Talk</button>
<button id="action">Action</button>
<button id="retry">Retry</button>
<button id="arrowBtn">➔</button>
<div id="overlay"></div>

<script>
const canvas = document.getElementById("game"),
      ctx    = canvas.getContext("2d"),
      W      = canvas.width,
      H      = canvas.height;

// UI refs
const ui = {
  quest:     document.getElementById("quest"),
  inventory: document.getElementById("inventory"),
  message:   document.getElementById("message"),
  retryBtn:  document.getElementById("retry"),
  arrowBtn:  document.getElementById("arrowBtn"),
  overlay:   document.getElementById("overlay")
};

// Assets
const bgImg     = new Image(); bgImg.src     = "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/b261ca70c131b5839ca620dcb62d7db18ce7ed41/IMG_1386.jpeg";
const streetBGs = [
  "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/687506a1872dba750c6815b6786bd6dfad83a00a/E9AB61A5-BF63-4E8F-A498-3B4F14986DB3.png",
  "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/687506a1872dba750c6815b6786bd6dfad83a00a/0D12C390-E751-4E8A-B499-399A75D2700E.png",
  "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/687506a1872dba750c6815b6786bd6dfad83a00a/72A10BEF-25D3-4C38-988E-4495BE09781A.png",
  "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/687506a1872dba750c6815b6786bd6dfad83a00a/18C84BD5-524A-4CBB-87BC-B2146A4A9557.png"
].map(url=>{const img=new Image();img.src=url;return img;});
const playerImg = new Image(); playerImg.src = "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/aea1a5bca8f5b71a8fc1fe7f23f3eaa52fda3723/IMG_1367.png";
const npcImg    = new Image(); npcImg.src    = "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/f420ee156479943f17286a1d2e79ad8e300852c4/IMG_1378.png";
const pillImg   = new Image(); pillImg.src   = "https://raw.githubusercontent.com/Herbachino1776/Sprites_N_Backgrounds/d3ada95b4a062a1c7b0ba059fd429e604dd7cc37/IMG_1376.png";

// State
let scene          = "peddler",
    questState     = 0,
    questCount     = 0,
    enemyGot       = 0,
    waiting        = false,
    waitTimer      = 0,
    arrowActive    = false,
    enemyMoveDelay = 0,
    overlayTimer   = 0,
    gameOver       = false,
    pillCollector  = null;

let inventory = 0, money = 0;

// Entities
const player = { x:300, y:220, w:32,  h:96, speed:120 };
const npc    = { x:0,   y:H-144,w:96, h:144, visible:true };
const pill   = { x:0,   y:0,   w:32, h:32, gotten:false };
const enemy  = { x:W-42,y:50,  w:32, h:96, speed:120 };
const cash   = { x:npc.x+24,y:npc.y,w:48,h:24, amount:200, visible:false };

// Input & tap-to-move
const input = { A:0 };
let dest = null;
canvas.addEventListener("pointerdown", e=>{
  const r=canvas.getBoundingClientRect(),
        x=e.clientX-r.left, y=e.clientY-r.top;
  dest = { x:x-player.w/2, y:y-player.h/2 };
});

function bindBtn(id,key){
  const el=document.getElementById(id);
  el.onpointerdown = ()=>{ input[key]=1; dest=null; };
  el.onpointerup   = ()=>{ input[key]=0; };
}
bindBtn("talk","A");
bindBtn("action","X");

ui.retryBtn.onclick = ()=>{ initGame(); };
ui.arrowBtn.onclick = ()=>{
  scene="streetfighter";
  ui.arrowBtn.style.display="none";
};

function overlap(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x &&
         a.y < b.y+b.h && a.y+a.h > b.y;
}

// spawn pill truly random—but ensure at least 200px away from both
function spawnPill(){
  const margin = 32,
        minD   = 200;
  let x,y,dp,de;
  do {
    x = margin + Math.random()*(W-2*margin);
    y = margin + Math.random()*(H-2*margin);
    dp = Math.hypot(x-player.x, y-player.y);
    de = Math.hypot(x-enemy.x,  y-enemy.y);
  } while(dp<minD || de<minD);
  pill.x = x; pill.y = y;
  pill.gotten = false;
  pillCollector = null;
}

function startQuest(){
  questState=1; spawnPill();
  ui.quest.textContent=`Quest: ${questCount+1}/3`;
  ui.overlay.innerText="Get the Pill!";
  ui.overlay.style.display="block";
  overlayTimer=1; enemyMoveDelay=1; enemyGot=0; waiting=false; gameOver=false;
}

function initGame(){
  scene="peddler";
  questState=inventory=money=enemyGot=questCount=0;
  waiting=arrowActive=false; enemyMoveDelay=overlayTimer=0;
  gameOver=false; pillCollector=null;
  ui.quest.textContent="Quest: None";
  ui.inventory.textContent="Pills: 0  Money: $0";
  ui.message.textContent="";
  ui.overlay.style.display="none";
  ui.retryBtn.style.display="none";
  ui.arrowBtn.style.display="none";
  npc.visible=true; cash.visible=false;
  dest=null;
  player.x=300; player.y=220;
  enemy.x=W-enemy.w-10; enemy.y=50;
}
initGame();

let last=0;
function loop(ts){
  const dt=(ts-last)/1000; last=ts;

  // hide intro overlay
  if(!gameOver && overlayTimer>0){
    overlayTimer-=dt;
    if(overlayTimer<=0) ui.overlay.style.display="none";
  }

  if(scene==="peddler"){
    // player move
    let mv=player.speed*dt;
    if(dest){
      let dx=dest.x-player.x, dy=dest.y-player.y, d=Math.hypot(dx,dy);
      if(d<mv){ player.x=dest.x; player.y=dest.y; dest=null;}
      else { player.x+=dx/d*mv; player.y+=dy/d*mv; }
    }
    player.x=Math.max(0,Math.min(W-player.w,player.x));
    player.y=Math.max(0,Math.min(H-player.h,player.y));

    // Talk
    if(input.A){
      if(questState===0 && npc.visible && overlap(player,npc)){
        startQuest();
      } else if(questState===2 && overlap(player,npc)){
        questCount++; money+=50; inventory=0;
        ui.inventory.textContent=`Pills:${inventory} Money:$${money}`;
        if(questCount<3){
          questState=0; ui.quest.textContent="Quest: None"; ui.message.textContent="Good job!";
        } else {
          questState=3; npc.visible=false; cash.visible=true;
          ui.message.textContent="NPC left cash!";
        }
      }
      input.A=0;
    }

    // player pickup
    if(questState===1 && pillCollector===null && overlap(player,pill)){
      pillCollector='player'; pill.gotten=true;
      inventory=1; questState=2;
      ui.inventory.textContent=`Pills:${inventory} Money:$${money}`;
      ui.quest.textContent="Return to NPC"; ui.message.textContent="You got the pill!";
    }

    // enemy chase
    if(questState===1 && pillCollector===null && !waiting){
      if(enemyMoveDelay>0){ enemyMoveDelay-=dt; }
      else {
        let dx=pill.x-enemy.x, dy=pill.y-enemy.y,
            d=Math.hypot(dx,dy), emv=enemy.speed*dt;
        if(d>emv){ enemy.x+=dx/d*emv; enemy.y+=dy/d*emv; }
        if(overlap(enemy,pill)){
          pillCollector='enemy'; enemyGot++;
          if(enemyGot<2){
            waiting=true; waitTimer=3;
            ui.message.textContent="Enemy got pill! Wait 3s...";
          } else {
            gameOver=true;
            ui.overlay.innerText="You got Burnt by Chezzy";
            ui.overlay.style.display="block";
            ui.retryBtn.style.display="block";
          }
        }
      }
    }
    if(waiting){
      waitTimer-=dt;
      if(waitTimer<=0){
        waiting=false; spawnPill();
        ui.message.textContent="New pill spawned!";
      }
    }

    // cash pickup
    if(questState===3 && cash.visible && overlap(player,cash)){
      money+=cash.amount;
      ui.inventory.textContent=`Pills:${inventory} Money:$${money}`;
      cash.visible=false; arrowActive=true;
      ui.arrowBtn.style.display="block";
      ui.message.textContent=`Picked up $${cash.amount}!`;
    }
  }

  // draw
  ctx.clearRect(0,0,W,H);
  if(scene==="peddler"){
    if(bgImg.complete) ctx.drawImage(bgImg,0,0,W,H);
    else { ctx.fillStyle="#333"; ctx.fillRect(0,0,W,H); }

    if(questState===1 && !pill.gotten && pillImg.complete){
      ctx.drawImage(pillImg,pill.x,pill.y,pill.w,pill.h);
    }
    if(npc.visible && npcImg.complete){
      ctx.drawImage(npcImg,npc.x,npc.y,npc.w,npc.h);
    }
    if(npcImg.complete){
      ctx.drawImage(npcImg,enemy.x,enemy.y,enemy.w,enemy.h);
    }
    if(cash.visible){
      ctx.fillStyle="gold"; ctx.fillRect(cash.x,cash.y,cash.w,cash.h);
      ctx.fillStyle="#000"; ctx.font="16px sans-serif";
      ctx.fillText(`$${cash.amount}`, cash.x+4, cash.y+16);
    }
    if(playerImg.complete){
      ctx.drawImage(playerImg,player.x,player.y,player.w,player.h);
    } else {
      ctx.fillStyle="lime"; ctx.fillRect(player.x,player.y,player.w,player.h);
    }
  } else {
    let bg = streetBGs[Math.min(questCount-1,streetBGs.length-1)];
    if(bg.complete) ctx.drawImage(bg,0,0,W,H);
  }

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
